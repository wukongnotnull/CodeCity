(window.webpackJsonp=window.webpackJsonp||[]).push([[172],{609:function(t,s,a){"use strict";a.r(s);var e=a(25),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"项目部署上线指南"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#项目部署上线指南"}},[t._v("#")]),t._v(" 项目部署上线指南")]),t._v(" "),a("h2",{attrs:{id:"准备上线"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#准备上线"}},[t._v("#")]),t._v(" 准备上线")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("上线前的检查工作。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("python manage.py check --deploy\n")])])])]),t._v(" "),a("li",[a("p",[t._v("将DEBUG设置为False并配置ALLOWED_HOSTS。")]),t._v(" "),a("div",{staticClass:"language-Python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[t._v("DEBUG "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("False")]),t._v("\nALLOWED_HOSTS "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'*'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("安全相关的配置。")]),t._v(" "),a("div",{staticClass:"language-Python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 保持HTTPS连接的时间")]),t._v("\nSECURE_HSTS_SECONDS "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3600")]),t._v("\nSECURE_HSTS_INCLUDE_SUBDOMAINS "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),t._v("\nSECURE_HSTS_PRELOAD "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 自动重定向到安全连接")]),t._v("\nSECURE_SSL_REDIRECT "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 避免浏览器自作聪明推断内容类型")]),t._v("\nSECURE_CONTENT_TYPE_NOSNIFF "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 避免跨站脚本攻击")]),t._v("\nSECURE_BROWSER_XSS_FILTER "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# COOKIE只能通过HTTPS进行传输")]),t._v("\nSESSION_COOKIE_SECURE "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),t._v("\nCSRF_COOKIE_SECURE "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 防止点击劫持攻击手段 - 修改HTTP协议响应头")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 当前网站是不允许使用<iframe>标签进行加载的")]),t._v("\nX_FRAME_OPTIONS "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'DENY'")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("敏感信息放到环境变量或文件中。")]),t._v(" "),a("div",{staticClass:"language-Python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[t._v("SECRET_KEY "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("environ"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'SECRET_KEY'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\nDB_USER "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("environ"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'DB_USER'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nDB_PASS "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("environ"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'DB_PASS'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\nREDIS_AUTH "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" os"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("environ"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'REDIS_AUTH'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])])])]),t._v(" "),a("h2",{attrs:{id:"更新服务器python环境到3-x"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#更新服务器python环境到3-x"}},[t._v("#")]),t._v(" 更新服务器Python环境到3.x")]),t._v(" "),a("blockquote",[a("p",[t._v("说明：如果需要清除之前的安装，就删除对应的文件和文件夹即可")])]),t._v(" "),a("ol",[a("li",[a("p",[t._v("安装底层依赖库。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("yum -y "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-devel tk-devel gdbm-devel libdb4-devel libpcap-devel xz-devel libffi-devel libxml2\n")])])])]),t._v(" "),a("li",[a("p",[t._v("下载Python源代码。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://www.python.org/ftp/python/3.7.6/Python-3.7.6.tar.xz\n")])])])]),t._v(" "),a("li",[a("p",[t._v("验证下载文件。")]),t._v(" "),a("div",{staticClass:"language-Bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("md5sum Python-3.7.6.tar.xz\n")])])])]),t._v(" "),a("li",[a("p",[t._v("解压缩和解归档。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("xz -d Python-3.7.6.tar.xz\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" -xvf Python-3.7.6.tar\n")])])])]),t._v(" "),a("li",[a("p",[t._v("执行安装前的配置（生成Makefile文件）。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" Python-3.7.6\n./configure --prefix"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("/usr/local/python37 --enable-optimizations\n")])])])]),t._v(" "),a("li",[a("p",[t._v("构建和安装。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("配置PATH环境变量（用户或系统环境变量）并激活。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" ~/.bash_profile\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" /etc/profile\n")])])]),a("div",{staticClass:"language-INI extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[t._v("... 此处省略上面的代码...\n\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("export PATH")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("$PATH:/usr/local/python37/bin")]),t._v("\n\n... 此处省略下面的代码...\n")])])]),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("source")]),t._v(" ~/.bash_profile\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("source")]),t._v(" /etc/profile\n")])])])]),t._v(" "),a("li",[a("p",[t._v("注册软链接（符号链接）- 这一步不是必须的，但通常会比较有用。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ln")]),t._v(" -s /usr/local/python37/bin/python3 /usr/bin/python3\n")])])])]),t._v(" "),a("li",[a("p",[t._v("测试Python环境是否更新成功（安装Python 3一定不能破坏原来的Python 2）。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("python3 --version\npython --version\n")])])])])]),t._v(" "),a("h2",{attrs:{id:"项目目录结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#项目目录结构"}},[t._v("#")]),t._v(" 项目目录结构")]),t._v(" "),a("p",[t._v("假设项目文件夹为"),a("code",[t._v("project")]),t._v("，下面的五个子目录分别是："),a("code",[t._v("code")]),t._v("、"),a("code",[t._v("conf")]),t._v("、"),a("code",[t._v("logs")]),t._v("、"),a("code",[t._v("stat")]),t._v("和"),a("code",[t._v("venv")]),t._v("分别用来保存项目的代码、配置文件、日志文件、静态资源和虚拟环境。其中，"),a("code",[t._v("conf")]),t._v("目录下的子目录"),a("code",[t._v("cert")]),t._v("中保存了配置HTTPS需要使用的证书和密钥；"),a("code",[t._v("code")]),t._v("目录下的项目代码可以通过版本控制工具从代码仓库中检出；虚拟环境可以通过工具（如：venv、virtualenv、pyenv等）进行创建。")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("project\n├── code\n│   └── fangtx\n│       ├── api\n│       ├── common\n│       ├── fangtx\n│       ├── forum\n│       ├── rent\n│       ├── user\n│       ├── manage.py\n│       ├── README.md\n│       ├── static\n│       └── templates\n├── conf\n│   ├── cert\n│   │   ├── 214915882850706.key\n│   │   └── 214915882850706.pem\n│   ├── nginx.conf\n│   └── uwsgi.ini\n├── logs\n│   ├── access.log\n│   ├── error.log\n│   └── uwsgi.log\n├── stat\n│   └── css\n│   └── images\n│   └── js\n└── venv\n    ├── bin\n    │   ├── activate\n    │   ├── activate.csh\n    │   ├── activate.fish\n    │   ├── celery\n    │   ├── celerybeat\n    │   ├── celeryd\n    │   ├── celeryd-multi\n    │   ├── coverage\n    │   ├── coverage3\n    │   ├── coverage-3.7\n    │   ├── django-admin\n    │   ├── django-admin.py\n    │   ├── easy_install\n    │   ├── easy_install-3.7\n    │   ├── pip\n    │   ├── pip3\n    │   ├── pip3.7\n    │   ├── __pycache__\n    │   ├── pyrsa-decrypt\n    │   ├── pyrsa-decrypt-bigfile\n    │   ├── pyrsa-encrypt\n    │   ├── pyrsa-encrypt-bigfile\n    │   ├── pyrsa-keygen\n    │   ├── pyrsa-priv2pub\n    │   ├── pyrsa-sign\n    │   ├── pyrsa-verify\n    │   ├── python -> python3\n    │   ├── python3 -> /usr/bin/python3\n    │   └── uwsgi\n    ├── include\n    ├── lib\n    │   └── python3.7\n    ├── lib64 -> lib\n    ├── pip-selfcheck.json\n    └── pyvenv.cfg\n")])])]),a("p",[t._v("下面以阿里云为例，简单说明如何为项目注册域名、解析域名以及购买权威机构颁发的证书。")]),t._v(" "),a("ol",[a("li",[a("p",[a("a",{attrs:{href:"https://wanwang.aliyun.com/domain/",target:"_blank",rel:"noopener noreferrer"}},[t._v("注册域名"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://cdn.jsdelivr.net/gh/wuKongNotNull/images-hosting/wukong-website/aliyun-domain.png"}})]),t._v(" "),a("li",[a("p",[a("a",{attrs:{href:"https://beian.aliyun.com/",target:"_blank",rel:"noopener noreferrer"}},[t._v("域名备案"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://cdn.jsdelivr.net/gh/wuKongNotNull/images-hosting/wukong-website/aliyun-keeprecord.png"}})]),t._v(" "),a("li",[a("p",[a("a",{attrs:{href:"https://dns.console.aliyun.com/#/dns/domainList",target:"_blank",rel:"noopener noreferrer"}},[t._v("域名解析"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://cdn.jsdelivr.net/gh/wuKongNotNull/images-hosting/wukong-website/aliyun-dnslist.png"}}),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://cdn.jsdelivr.net/gh/wuKongNotNull/images-hosting/wukong-website/aliyun-resolve-settings.png"}})]),t._v(" "),a("li",[a("p",[a("a",{attrs:{href:"https://www.aliyun.com/product/cas",target:"_blank",rel:"noopener noreferrer"}},[t._v("购买证书"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("img",{staticStyle:{zoom:"50%"},attrs:{src:"https://cdn.jsdelivr.net/gh/wuKongNotNull/images-hosting/wukong-website/aliyun-certificate.png"}})])]),t._v(" "),a("p",[t._v("可以使用类似于sftp的工具将证书上传到"),a("code",[t._v("conf/cert")]),t._v("目录，然后使用git克隆项目代码到"),a("code",[t._v("code")]),t._v("目录。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" code\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("git")]),t._v(" clone "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("url"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),a("p",[t._v("回到项目目录，创建并激活虚拟环境。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("python3 -m venv venv\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("source")]),t._v(" venv/bin/activate\n")])])]),a("p",[t._v("重建项目依赖项。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("pip "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" -r code/teamproject/requirements.txt\n")])])]),a("h2",{attrs:{id:"uwsgi的配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#uwsgi的配置"}},[t._v("#")]),t._v(" uWSGI的配置")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("安装uWSGI。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("pip "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" uwsgi\n")])])])]),t._v(" "),a("li",[a("p",[t._v("修改uWSGI的配置文件（"),a("code",[t._v("/root/project/conf/uwsgi.ini")]),t._v("）。")]),t._v(" "),a("div",{staticClass:"language-INI extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token header"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token section-name selector"}},[t._v("uwsgi")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 配置前导路径")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("base")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("/root/project")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 配置项目名称")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("teamproject")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 守护进程")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("master")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("true")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 进程个数")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("processes")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("4")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 虚拟环境")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("pythonhome")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("%(base)/venv")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 项目地址")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("chdir")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("%(base)/code/%(name)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 指定python解释器")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("pythonpath")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("%(pythonhome)/bin/python")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 指定uwsgi文件")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("module")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("%(name).wsgi")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 通信的地址和端口(自己服务器的IP地址和端口)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("socket")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("172.18.61.250:8000")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 日志文件地址")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("logto")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("%(base)/logs/uwsgi.log")]),t._v("\n")])])]),a("blockquote",[a("p",[t._v("说明：可以先将“通信的地址和端口”项等号前面改为http来进行测试，如果没有问题再改回    成socket，然后通过Nginx来实现项目的“动静分离”（静态资源交给Nginx处理，动态内容交给    uWSGI处理）。按照下面的方式可以启动uWSGI服务器。")])])]),t._v(" "),a("li",[a("p",[t._v("启动服务器。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("nohup")]),t._v(" uwsgi --ini conf/uwsgi.ini "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("\n")])])])])]),t._v(" "),a("h2",{attrs:{id:"nginx的配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#nginx的配置"}},[t._v("#")]),t._v(" Nginx的配置")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("安装Nginx。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("yum -y "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" nginx\n")])])])]),t._v(" "),a("li",[a("p",[t._v("修改全局配置文件（"),a("code",[t._v("/etc/nginx/nginx.conf")]),t._v("）。")]),t._v(" "),a("div",{staticClass:"language-Nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 配置用户")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("user")]),t._v(" nginx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 工作进程数(建议跟CPU的核数量一致)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("worker_processes")]),t._v(" auto")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 错误日志")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("error_log")]),t._v(" /var/log/nginx/error.log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 进程文件")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("pid")]),t._v(" /run/nginx.pid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 包含其他的配置")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("include")]),t._v(" /usr/share/nginx/modules/*.conf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 工作模式(多路IO复用方式)和连接上限")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("events")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("use")]),t._v(" epoll")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("worker_connections")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# HTTP服务器相关配置")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("http")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 日志格式")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("log_format")]),t._v("  main  "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_addr")]),t._v(" - "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_user")]),t._v(" ["),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$time_local]")]),t._v(' "'),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$request")]),t._v("\" '")]),t._v("\n                      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'"),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$status")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$body_bytes_sent")]),t._v(' "'),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$http_referer")]),t._v("\" '")]),t._v("\n                      "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'\""),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$http_user_agent")]),t._v('" "'),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$http_x_forwarded_for")]),t._v("\"'")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 访问日志")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("access_log")]),t._v("  /var/log/nginx/access.log  main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 开启高效文件传输模式")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("sendfile")]),t._v("            "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("on")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 用sendfile传输文件时有利于改善性能")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("tcp_nopush")]),t._v("          "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("on")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 禁用Nagle来解决交互性问题")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("tcp_nodelay")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("on")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 客户端保持连接时间")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("keepalive_timeout")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("types_hash_max_size")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2048")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 包含MIME类型的配置")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("include")]),t._v("             /etc/nginx/mime.types")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 默认使用二进制流格式")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("default_type")]),t._v("        application/octet-stream")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 包含其他配置文件")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("include")]),t._v(" /etc/nginx/conf.d/*.conf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 包含项目的Nginx配置文件")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("include")]),t._v(" /root/project/conf/*.conf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("编辑局部配置文件（"),a("code",[t._v("/root/project/conf/nginx.conf")]),t._v("）。")]),t._v(" "),a("div",{staticClass:"language-Nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v(" _")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("access_log")]),t._v(" /root/project/logs/access.log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("error_log")]),t._v(" /root/project/logs/error.log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("include")]),t._v(" uwsgi_params")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uwsgi_pass")]),t._v(" 172.18.61.250:8000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /static/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("alias")]),t._v(" /root/project/stat/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("expires")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30d")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server_name")]),t._v(" _")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl")]),t._v("         "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("on")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("access_log")]),t._v(" /root/project/logs/access.log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("error_log")]),t._v(" /root/project/logs/error.log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_certificate")]),t._v("     /root/project/conf/cert/214915882850706.pem")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_certificate_key")]),t._v(" /root/project/conf/cert/214915882850706.key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_session_timeout")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5m")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_ciphers")]),t._v(" ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_protocols")]),t._v(" TLSv1 TLSv1.1 TLSv1.2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_prefer_server_ciphers")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("on")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("include")]),t._v(" uwsgi_params")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("uwsgi_pass")]),t._v(" 172.18.61.250:8000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /static/")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("alias")]),t._v(" /root/project/static/")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("expires")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("30d")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("p",[t._v("到此为止，我们可以启动Nginx来访问我们的应用程序，HTTP和HTTPS都是没有问题的，如果Nginx已经运行，在修改配置文件后，我们可以用下面的命令重新启动Nginx。")])]),t._v(" "),a("li",[a("p",[t._v("重启Nginx服务器。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("nginx -s reload\n")])])]),a("p",[t._v("或")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("systemctl restart nginx\n")])])])])]),t._v(" "),a("blockquote",[a("p",[t._v("说明：可以对Django项目使用"),a("code",[t._v("python manage.py collectstatic")]),t._v("命令将静态资源收集到指定目录下，要做到这点只需要在项目的配置文件"),a("code",[t._v("settings.py")]),t._v("中添加"),a("code",[t._v("STATIC_ROOT")]),t._v("配置即可。")])]),t._v(" "),a("h3",{attrs:{id:"负载均衡配置"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#负载均衡配置"}},[t._v("#")]),t._v(" 负载均衡配置")]),t._v(" "),a("p",[t._v("下面的配置中我们使用Nginx实现负载均衡，为另外的三个Nginx服务器（通过Docker创建）提供反向代理服务。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("docker run -d -p "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("801")]),t._v(":80 --name nginx1 nginx:latest\ndocker run -d -p "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("802")]),t._v(":80 --name nginx2 nginx:latest\ndocker run -d -p "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("803")]),t._v(":80 --name nginx3 nginx:latest\n")])])]),a("div",{staticClass:"language-Nginx extra-class"},[a("pre",{pre:!0,attrs:{class:"language-nginx"}},[a("code",[a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("user")]),t._v(" root")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("worker_processes")]),t._v(" auto")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("error_log")]),t._v(" /var/log/nginx/error.log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("pid")]),t._v(" /run/nginx.pid")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("include")]),t._v(" /usr/share/nginx/modules/*.conf")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("events")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("worker_connections")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1024")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 为HTTP服务配置负载均衡")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("http")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("upstream")]),t._v(" xx")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" 192.168.1.100 weight=2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" 192.168.1.101 weight=1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")]),t._v(" 192.168.1.102 weight=1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("server")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("       "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(" default_server")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("       [::]:80 default_server")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("       "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(" ssl")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("listen")]),t._v("       [::]:443 ssl")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("on")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("access_log")]),t._v(" /root/project/logs/access.log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("error_log")]),t._v(" /root/project/logs/error.log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_certificate")]),t._v(" /root/project/conf/cert/214915882850706.pem")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_certificate_key")]),t._v(" /root/project/conf/cert/214915882850706.key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_session_timeout")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5m")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_ciphers")]),t._v(" ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_protocols")]),t._v(" TLSv1 TLSv1.1 TLSv1.2")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ssl_prefer_server_ciphers")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("on")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("location")]),t._v(" /")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" Host "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$host")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_set_header")]),t._v(" X-Forwarded-For "),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$remote_addr")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# proxy_set_header X-Real-IP $remote_addr;")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_buffering")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("off")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t\t"),a("span",{pre:!0,attrs:{class:"token directive"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("proxy_pass")]),t._v(" http://fangtx")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("blockquote",[a("p",[t._v("说明：Nginx在配置负载均衡时，默认使用WRR（加权轮询算法），除此之外还支持ip_hash、fair（需要安装upstream_fair模块）和url_hash算法。此外，在配置upstream模块时可以指定服务器的状态值，包括：backup（备份机器，其他服务器不可用时才将请求分配到该机器）、down、fail_timeout（请求失败达到max_fails后的暂停服务时间）、max_fails（允许请求失败的次数）和weight（轮询的权重）。")])]),t._v(" "),a("h2",{attrs:{id:"keepalived"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#keepalived"}},[t._v("#")]),t._v(" Keepalived")]),t._v(" "),a("p",[t._v("当使用Nginx进行负载均衡配置时，要考虑负载均衡服务器宕机的情况。为此可以使用Keepalived来实现负载均衡主机和备机的热切换，从而保证系统的高可用性。Keepalived的配置还是比较复杂，通常由专门做运维的人进行配置，一个基本的配置可以参照"),a("a",{attrs:{href:"https://www.jianshu.com/p/dd93bc6d45f5",target:"_blank",rel:"noopener noreferrer"}},[t._v("《Keepalived的配置和使用》"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("h2",{attrs:{id:"mysql主从复制"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mysql主从复制"}},[t._v("#")]),t._v(" MySQL主从复制")]),t._v(" "),a("p",[t._v("下面还是基于Docker来演示如何配置MySQL主从复制。我们事先准备好MySQL的配置文件以及保存MySQL数据和运行日志的目录，然后通过Docker的数据卷映射来指定容器的配置、数据和日志文件的位置。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("root\n└── mysql\n    ├── master\n    │   ├── conf\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\t└── data\n    └── slave-1\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\t├── conf\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\t└── data\n    └── slave-2\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\t├── conf\n    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\t└── data\n    └── slave-3\n    \t├── conf\n    \t└── data\n")])])]),a("ol",[a("li",[a("p",[t._v("MySQL的配置文件（master和slave的配置文件需要不同的server-id）。")]),t._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("[mysqld]\npid-file=/var/run/mysqld/mysqld.pid\nsocket=/var/run/mysqld/mysqld.sock\ndatadir=/var/lib/mysql\nlog-error=/var/log/mysql/error.log\nserver-id=1\nlog-bin=/var/log/mysql/mysql-bin.log\nexpire_logs_days=30\nmax_binlog_size=256M\nsymbolic-links=0\n# slow_query_log=ON\n# slow_query_log_file=/var/log/mysql/slow.log\n# long_query_time=1\n")])])])]),t._v(" "),a("li",[a("p",[t._v("创建和配置master。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("docker run -d -p "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3306")]),t._v(":3306 --name mysql-master "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-v /root/mysql/master/conf:/etc/mysql/mysql.conf.d "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-v /root/mysql/master/data:/var/lib/mysql "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("MYSQL_ROOT_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("123456")]),t._v(" mysql:5.7\n\ndocker "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" -it mysql-master /bin/bash\n")])])]),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("mysql -u root -p\nEnter password:\nWelcome to the MySQL monitor.  Commands end with "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" or "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("g.\nYour MySQL connection "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" is "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\nServer version: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.7")]),t._v(".23-log MySQL Community Server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("GPL"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nCopyright "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2000")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2018")]),t._v(", Oracle and/or its affiliates. All rights reserved.\nOracle is a registered trademark of Oracle Corporation and/or its\naffiliates. Other names may be trademarks of their respective\nowners.\nType "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'help;'")]),t._v(" or "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'\\h'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" help. Type "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'\\c'")]),t._v(" to "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("clear")]),t._v(" the current input statement.\n\nmysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" grant replication slave on *.* to "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'slave'")]),t._v("@"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%'")]),t._v(" identified by "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'iamslave'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nQuery OK, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" rows affected, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" warning "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.00")]),t._v(" sec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nmysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" flush privileges"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nQuery OK, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" rows affected "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.00")]),t._v(" sec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nmysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" show master status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n+------------------+----------+--------------+------------------+-------------------+\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" File             "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Position "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Binlog_Do_DB "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Binlog_Ignore_DB "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" Executed_Gtid_Set "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n+------------------+----------+--------------+------------------+-------------------+\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v(" mysql-bin.000003 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("590")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("              "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("                  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("                   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n+------------------+----------+--------------+------------------+-------------------+\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" row "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.00")]),t._v(" sec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nmysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" quit\nBye\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exit")]),t._v("\n")])])]),a("p",[t._v("上面创建Docker容器时使用的"),a("code",[t._v("-v")]),t._v("参数（"),a("code",[t._v("--volume")]),t._v("）表示映射数据卷，冒号前是宿主机的目录，冒号后是容器中的目录，这样相当于将宿主机中的目录挂载到了容器中。")])]),t._v(" "),a("li",[a("p",[t._v("备份主表中的数据（如果需要的话）。")]),t._v(" "),a("div",{staticClass:"language-SQL extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("mysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" flush "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("table")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("with")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("read")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("lock")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("div",{staticClass:"language-Bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("mysqldump -u root -p "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("123456")]),t._v(" -A -B "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /root/backup/mysql/mybak"),a("span",{pre:!0,attrs:{class:"token variable"}},[a("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$(")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("date")]),t._v(" +"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"%Y%m%d%H%M%S"')]),a("span",{pre:!0,attrs:{class:"token variable"}},[t._v(")")])]),t._v(".sql\n")])])]),a("div",{staticClass:"language-SQL extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sql"}},[a("code",[t._v("mysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("unlock")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("table")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("创建和配置slave。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("docker run -d -p "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3308")]),t._v(":3306 --name mysql-slave-1 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-v /root/mysql/slave-1/conf:/etc/mysql/mysql.conf.d "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-v /root/mysql/slave-1/data:/var/lib/mysql "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("MYSQL_ROOT_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("123456")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--link mysql-master:mysql-master mysql:5.7\n\ndocker run -d -p "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3309")]),t._v(":3306 --name mysql-slave-2 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-v /root/mysql/slave-2/conf:/etc/mysql/mysql.conf.d "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-v /root/mysql/slave-2/data:/var/lib/mysql "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("MYSQL_ROOT_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("123456")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--link mysql-master:mysql-master mysql:5.7\n\ndocker run -d -p "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3310")]),t._v(":3306 --name mysql-slave-3 "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-v /root/mysql/slave-3/conf:/etc/mysql/mysql.conf.d "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-v /root/mysql/slave-3/data:/var/lib/mysql "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n-e "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("MYSQL_ROOT_PASSWORD")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("123456")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n--link mysql-master:mysql-master mysql:5.7\n\ndocker "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exec")]),t._v(" -it mysql-slave-1 /bin/bash\n")])])]),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("mysql -u root -p\nEnter password:\nWelcome to the MySQL monitor.  Commands end with "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" or "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("g.\nYour MySQL connection "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("id")]),t._v(" is "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v("\nServer version: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.7")]),t._v(".23-log MySQL Community Server "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("GPL"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nCopyright "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("c"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2000")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2018")]),t._v(", Oracle and/or its affiliates. All rights reserved.\nOracle is a registered trademark of Oracle Corporation and/or its\naffiliates. Other names may be trademarks of their respective\nowners.\nType "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'help;'")]),t._v(" or "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'\\h'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" help. Type "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'\\c'")]),t._v(" to "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("clear")]),t._v(" the current input statement.\n\nmysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" reset slave"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nQuery OK, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" rows affected "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.02")]),t._v(" sec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nmysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" change master to "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("master_host")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mysql-master'")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("master_user")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'slave'")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("master_password")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'iamslave'")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("master_log_file")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mysql-bin.000003'")]),t._v(", "),a("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("master_log_pos")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("590")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nQuery OK, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" rows affected, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" warnings "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.03")]),t._v(" sec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nmysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" start slave"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nQuery OK, "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" rows affected "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.01")]),t._v(" sec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nmysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" show slave status"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("G\n*************************** "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(". row ***************************\n               Slave_IO_State: Waiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" master to send event\n                  Master_Host: mysql57\n                  Master_User: slave\n                  Master_Port: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("3306")]),t._v("\n                Connect_Retry: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),t._v("\n              Master_Log_File: mysql-bin.000001\n          Read_Master_Log_Pos: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("590")]),t._v("\n               Relay_Log_File: f352f05eb9d0-relay-bin.000002\n                Relay_Log_Pos: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("320")]),t._v("\n        Relay_Master_Log_File: mysql-bin.000001\n             Slave_IO_Running: Yes\n            Slave_SQL_Running: Yes\n             Replicate_Do_DB:\n          Replicate_Ignore_DB:\n           Replicate_Do_Table:\n       Replicate_Ignore_Table:\n      Replicate_Wild_Do_Table:\n  Replicate_Wild_Ignore_Table:\n                   Last_Errno: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n                   Last_Error:\n                 Skip_Counter: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n          Exec_Master_Log_Pos: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("590")]),t._v("\n              Relay_Log_Space: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("534")]),t._v("\n              Until_Condition: None\n               Until_Log_File:\n                Until_Log_Pos: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n           Master_SSL_Allowed: No\n           Master_SSL_CA_File:\n           Master_SSL_CA_Path:\n              Master_SSL_Cert:\n            Master_SSL_Cipher:\n               Master_SSL_Key:\n        Seconds_Behind_Master: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\nMaster_SSL_Verify_Server_Cert: No\n                Last_IO_Errno: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n                Last_IO_Error:\n               Last_SQL_Errno: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n               Last_SQL_Error:\n  Replicate_Ignore_Server_Ids:\n             Master_Server_Id: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n                  Master_UUID: 30c38043-ada1-11e8-8fa1-0242ac110002\n             Master_Info_File: /var/lib/mysql/master.info\n                    SQL_Delay: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n          SQL_Remaining_Delay: NULL\n      Slave_SQL_Running_State: Slave has "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("read")]),t._v(" all relay log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" waiting "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("more")]),t._v(" updates\n           Master_Retry_Count: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("86400")]),t._v("\n                  Master_Bind:\n      Last_IO_Error_Timestamp:\n     Last_SQL_Error_Timestamp:\n               Master_SSL_Crl:\n           Master_SSL_Crlpath:\n           Retrieved_Gtid_Set:\n            Executed_Gtid_Set:\n                Auto_Position: "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n         Replicate_Rewrite_DB:\n                 Channel_Name:\n           Master_TLS_Version:\n"),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" row "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("in")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("set")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0.00")]),t._v(" sec"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nmysql"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" quit\nBye\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("exit")]),t._v("\n")])])]),a("p",[t._v("接下来可以如法炮制配置出slave2和slave3，这样就可以搭建起一个“一主带三从”的主从复制环境。上面创建创建容器时使用的"),a("code",[t._v("--link")]),t._v("参数用来配置容器在网络上的主机名（网络地址别名）。")])])]),t._v(" "),a("p",[t._v("配置好主从复制后，写数据的操作应该master上执行，而读数据的操作应该在slave上完成。为此，在Django项目中需要配置DATABASE_ROUTERS并通过自定义的主从复制路由类来实现读写分离操作，如下所示：")]),t._v(" "),a("div",{staticClass:"language-Python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[t._v("DATABASE_ROUTERS "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 此处省略其他配置")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'common.routers.MasterSlaveRouter'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),a("div",{staticClass:"language-Python extra-class"},[a("pre",{pre:!0,attrs:{class:"language-python"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("MasterSlaveRouter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("object")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v('"""主从复制路由"""')]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@staticmethod")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("db_for_read")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("model"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("**")]),t._v("hints"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v('"""\n        Attempts to read auth models go to auth_db.\n        """')]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" random"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("choice"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'slave1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'slave2'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'slave3'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@staticmethod")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("db_for_write")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("model"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("**")]),t._v("hints"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v('"""\n        Attempts to write auth models go to auth_db.\n        """')]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'default'")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@staticmethod")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("allow_relation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("obj1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" obj2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("**")]),t._v("hints"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v('"""\n        Allow relations if a model in the auth app is involved.\n        """')]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),t._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token decorator annotation punctuation"}},[t._v("@staticmethod")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("allow_migrate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("db"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" app_label"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" model_name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("None")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("**")]),t._v("hints"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token triple-quoted-string string"}},[t._v('"""\n        Make sure the auth app only appears in the \'auth_db\'\n        database.\n        """')]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("True")]),t._v("\n")])])]),a("p",[t._v("上面的内容参考了Django官方文档的"),a("a",{attrs:{href:"https://docs.djangoproject.com/en/2.1/topics/db/multi-db/#topics-db-multi-db-routing",target:"_blank",rel:"noopener noreferrer"}},[t._v("DATABASE_ROUTERS配置"),a("OutboundLink")],1),t._v("，对代码进行了适当的调整。")]),t._v(" "),a("h2",{attrs:{id:"docker"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#docker"}},[t._v("#")]),t._v(" Docker")]),t._v(" "),a("p",[t._v("事实上，项目上线中最为麻烦的事情就是配置软件运行环境，环境的差异会给软件的安装和部署带来诸多的麻烦，而Docker正好可以解决这个问题。关于Docker在之前的文档中我们已经介绍过了，接下来我们对Docker的知识做一些必要的补充。")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("创建镜像文件。")]),t._v(" "),a("p",[t._v("将容器保存成镜像：")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("docker commit -m "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"..."')]),t._v(" -a "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"jackfrued"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("container-name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" jackfrued/"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("image-name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])]),a("p",[t._v("使用Dockerfile构建镜像：")]),t._v(" "),a("div",{staticClass:"language-Dockerfile extra-class"},[a("pre",{pre:!0,attrs:{class:"language-dockerfile"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 指定基础镜像文件")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" centos:latest")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 指定维护者信息")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("MAINTAINER")]),t._v(" jackfrued")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 执行命令")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" yum -y install gcc")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" cd ~")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" mkdir -p project/code")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("RUN")]),t._v(" mkdir -p project/logs")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 拷贝文件")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("COPY")]),t._v(" ...")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 暴露端口")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("EXPOSE")]),t._v(" ...")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 在容器启动时执行命令")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token instruction"}},[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("CMD")]),t._v(" ~/init.sh")]),t._v("\n")])])]),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("docker build -t jackfrued/"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("image-name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v(".")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("镜像的导入和导出。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("docker save -o "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("file-name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(".tar "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("image-name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(":"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("version"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\ndocker load -i "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("file-name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(".tar\n")])])])]),t._v(" "),a("li",[a("p",[t._v("推送到DockerHub服务器。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("docker tag "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("image-name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(":"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("version"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" jackfrued/"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\ndocker login\ndocker push jackfrued/"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("容器之间的通信。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("docker run --link "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("container-name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(":"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v("alias-name"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n")])])])])]),t._v(" "),a("p",[t._v("如果我们能够在Docker中完成项目的部署，并且将整个部署好的容器打包成镜像文件进行分发和安装，这样就可以解决项目在多个节点上进行部署时可能遇到的麻烦，而且整个部署可以在很短的时间内完成。")]),t._v(" "),a("h2",{attrs:{id:"supervisor"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#supervisor"}},[t._v("#")]),t._v(" Supervisor")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/Supervisor/supervisor",target:"_blank",rel:"noopener noreferrer"}},[t._v("Supervisor"),a("OutboundLink")],1),t._v("是一个用Python写的进程管理工具，可以很方便的用来在类Unix系统下启动、重启（自动重启程序）和关闭进程，目前Supervisor暂时还没有提供对Python 3的支持，可以通过Python 2来安装和运行Supervisor，再通过Supervisor来管理Python 3的程序。")]),t._v(" "),a("blockquote",[a("p",[a("strong",[t._v("提示")]),t._v("：还有一个和Supervisor功能类似的工具名为Circus，支持Python 3。")])]),t._v(" "),a("ol",[a("li",[a("p",[t._v("安装Supervisor。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("virtualenv -p /usr/bin/python venv\n"),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("source")]),t._v(" venv/bin/activate\npip "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" supervisor\n")])])])]),t._v(" "),a("li",[a("p",[t._v("查看Supervisor的配置文件。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" /etc/supervisord.conf\n")])])]),a("div",{staticClass:"language-INI extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("; 此处省略上面的代码")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('; The [include] section can just contain the "files" setting.  This')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("; setting can list multiple files (separated by whitespace or")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("; newlines).  It can also contain wildcards.  The filenames are")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("; interpreted as relative to this file.  Included files *cannot*")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("; include files themselves.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token header"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token section-name selector"}},[t._v("include")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("files")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("supervisord.d/*.ini")]),t._v("\n")])])]),a("p",[t._v("可以看出自定义的管理配置代码可以放在"),a("code",[t._v("/etc/supervisord.d")]),t._v("目录中，并且文件名以"),a("code",[t._v("ini")]),t._v("作为后缀即可。")])]),t._v(" "),a("li",[a("p",[t._v("编写自己的配置文件"),a("code",[t._v("fangtx.ini")]),t._v("并放在"),a("code",[t._v("/etc/supervisord.d")]),t._v("目录中。")]),t._v(" "),a("div",{staticClass:"language-INI extra-class"},[a("pre",{pre:!0,attrs:{class:"language-ini"}},[a("code",[a("span",{pre:!0,attrs:{class:"token header"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token section-name selector"}},[t._v("program:project")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("uwsgi --ini /root/project/conf/uwsgi.ini")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("stopsignal")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("QUIT")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("autostart")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("true")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("autorestart")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("true")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("redirect_stderr")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("true")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token header"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token section-name selector"}},[t._v("program:celery")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")])]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("; Set full path to celery program if using virtualenv")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("command")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("/root/project/venv/bin/celery -A fangtx worker")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("user")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("root")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("numprocs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("1")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("stdout_logfile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("/var/log/supervisor/celery.log")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("stderr_logfile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("/var/log/supervisor/celery_error.log")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("autostart")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("true")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("autorestart")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("true")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("startsecs")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("10")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("; Need to wait for currently executing tasks to finish at shutdown.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("; Increase this if you have very long running tasks.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v(";stopwaitsecs = 600")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("; When resorting to send SIGKILL to the program to terminate it")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("; send SIGKILL to its whole process group instead,")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("; taking care of its children as well.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("killasgroup")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("true")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("; Set Celery priority higher than default (999)")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("; so, if rabbitmq is supervised, it will start first.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token key attr-name"}},[t._v("priority")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("=")]),a("span",{pre:!0,attrs:{class:"token value attr-value"}},[t._v("1000")]),t._v("\n")])])])]),t._v(" "),a("li",[a("p",[t._v("启动Supervisor。")]),t._v(" "),a("div",{staticClass:"language-Shell extra-class"},[a("pre",{pre:!0,attrs:{class:"language-shell"}},[a("code",[t._v("supervisorctl -c /etc/supervisord.conf\n")])])])])]),t._v(" "),a("h2",{attrs:{id:"其他服务"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#其他服务"}},[t._v("#")]),t._v(" 其他服务")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("常用开源软件。")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("功能")]),t._v(" "),a("th",[t._v("开源方案")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("版本控制工具")]),t._v(" "),a("td",[t._v("Git、Mercurial、SVN")])]),t._v(" "),a("tr",[a("td",[t._v("缺陷管理")]),t._v(" "),a("td",[t._v("Redmine、Mantis")])]),t._v(" "),a("tr",[a("td",[t._v("负载均衡")]),t._v(" "),a("td",[t._v("Nginx、LVS、HAProxy")])]),t._v(" "),a("tr",[a("td",[t._v("邮件服务")]),t._v(" "),a("td",[t._v("Postfix、Sendmail")])]),t._v(" "),a("tr",[a("td",[t._v("HTTP服务")]),t._v(" "),a("td",[t._v("Nginx、Apache")])]),t._v(" "),a("tr",[a("td",[t._v("消息队列")]),t._v(" "),a("td",[t._v("RabbitMQ、ZeroMQ、Redis、Kafka")])]),t._v(" "),a("tr",[a("td",[t._v("文件系统")]),t._v(" "),a("td",[t._v("FastDFS")])]),t._v(" "),a("tr",[a("td",[t._v("基于位置服务（LBS）")]),t._v(" "),a("td",[t._v("MongoDB、Redis")])]),t._v(" "),a("tr",[a("td",[t._v("监控服务")]),t._v(" "),a("td",[t._v("Nagios、Zabbix")])]),t._v(" "),a("tr",[a("td",[t._v("关系型数据库")]),t._v(" "),a("td",[t._v("MySQL、PostgreSQL")])]),t._v(" "),a("tr",[a("td",[t._v("非关系型数据库")]),t._v(" "),a("td",[t._v("MongoDB、Redis、Cassandra、TiDB")])]),t._v(" "),a("tr",[a("td",[t._v("搜索引擎")]),t._v(" "),a("td",[t._v("ElasticSearch、Solr")])]),t._v(" "),a("tr",[a("td",[t._v("缓存服务")]),t._v(" "),a("td",[t._v("Mamcached、Redis")])])])])]),t._v(" "),a("li",[a("p",[t._v("常用云服务。")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("功能")]),t._v(" "),a("th",[t._v("可用的云服务")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("团队协作工具")]),t._v(" "),a("td",[t._v("Teambition、钉钉")])]),t._v(" "),a("tr",[a("td",[t._v("代码托管平台")]),t._v(" "),a("td",[t._v("Github、Gitee、CODING")])]),t._v(" "),a("tr",[a("td",[t._v("邮件服务")]),t._v(" "),a("td",[t._v("SendCloud")])]),t._v(" "),a("tr",[a("td",[t._v("云存储（CDN）")]),t._v(" "),a("td",[t._v("七牛、OSS、LeanCloud、Bmob、又拍云、S3")])]),t._v(" "),a("tr",[a("td",[t._v("移动端推送")]),t._v(" "),a("td",[t._v("极光、友盟、百度")])]),t._v(" "),a("tr",[a("td",[t._v("即时通信")]),t._v(" "),a("td",[t._v("环信、融云")])]),t._v(" "),a("tr",[a("td",[t._v("短信服务")]),t._v(" "),a("td",[t._v("云片、极光、Luosimao、又拍云")])]),t._v(" "),a("tr",[a("td",[t._v("第三方登录")]),t._v(" "),a("td",[t._v("友盟、ShareSDK")])]),t._v(" "),a("tr",[a("td",[t._v("网站监控和统计")]),t._v(" "),a("td",[t._v("阿里云监控、监控宝、百度云观测、小鸟云")])])])])])])])}),[],!1,null,null,null);s.default=n.exports}}]);